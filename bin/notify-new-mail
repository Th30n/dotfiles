#!/usr/bin/env python3
import argparse
import base64
import os
import quopri
import subprocess

_NOTIFY_FMT = "notify-send -u normal -c mail 'New mail [{mail_dir}]' '{subject}'"


def _notify_send(mail_dir='INBOX', subject='<NO SUBJECT>'):
    subprocess.check_output(_NOTIFY_FMT.format(mail_dir=mail_dir, subject=subject),
                            shell=True)


def _decode_header(header_string):
    '''Decode header contents as defined in RFC 1342'''
    header_string = header_string.strip()
    if header_string.startswith('=?') and header_string.endswith('?='):
        [_, charset, encoding, contents, _] = header_string.split('?')
        if charset.lower() != 'utf-8' or encoding not in ('B', 'Q'):
            return header_string
        if encoding == 'B':
            return base64.b64decode(contents).decode(charset)
        assert encoding == 'Q'
        return quopri.decodestring(contents).decode(charset)
    else:
        return header_string


parser = argparse.ArgumentParser(description='Check for new mail and send desktop notification')
parser.add_argument('--account', '-a', type=str, required=True, dest='account')
parser.add_argument('--mail-dir', '-m', type=str, dest='mail_dir',
                    default=os.path.join(os.getenv('HOME'), 'Mail'))
args = parser.parse_args()

account_dir = os.path.join(args.mail_dir, args.account)
for mail_dir in os.listdir(account_dir):
    new_dir = os.path.join(account_dir, mail_dir, 'new')
    if not os.path.isdir(new_dir):
        continue
    with os.scandir(new_dir) as mail_it:
        for mail in mail_it:
            atime = int(mail.stat().st_atime)
            mtime = int(mail.stat().st_mtime)
            if atime - mtime >= 60:
                continue
            with open(mail) as mail_contents:
                for line in mail_contents:
                    subject = 'Subject: '
                    if line.startswith(subject):
                        _notify_send(mail_dir=mail_dir,
                                     subject=_decode_header(line[len(subject):]))
                        break
                else:
                    _notify_send(mail_dir=mail_dir)
